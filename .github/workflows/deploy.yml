name: deploy 

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy on server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Run deployment commands on server
        run: |
          ssh -o StrictHostKeyChecking=no github_actions@${{ secrets.SERVER_IP }} << 'EOF'
            set -e  # Exit on error
            echo "Starting deployment process..."
            
            # Add GitHub to known_hosts
            echo "Adding GitHub to known_hosts..."
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            
            # Define o repositório como seguro para evitar erros de "dubious ownership"
            echo "Configuring git safe directory..."
            git config --global --add safe.directory ${{ secrets.PATH_PROJECT }}

            # Acessa o diretório do projeto
            echo "Changing to project directory..."
            cd ${{ secrets.PATH_PROJECT }} || { echo "Failed to change directory"; exit 1; }

            # Atualiza o código
            echo "Pulling latest changes..."
            git pull origin master || { echo "Failed to pull changes"; exit 1; }

            # Instala dependências PHP
            echo "Installing PHP dependencies..."
            composer install --no-interaction --prefer-dist --optimize-autoloader || { echo "Failed to install PHP dependencies"; exit 1; }

            # Executa as migrations forçadas
            echo "Running database migrations..."
            php artisan migrate --force || { echo "Failed to run migrations"; exit 1; }

            # Instala e compila os assets do front-end
            echo "Installing and building frontend assets..."
            npm install || { echo "Failed to install npm dependencies"; exit 1; }
            npm run build || { echo "Failed to build frontend assets"; exit 1; }

            echo "Deployment completed successfully!"
          EOF
